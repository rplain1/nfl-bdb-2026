
```{python}

import polars as pl
import duckdb
import numpy as np
```


```{python}
def get_player_data():
    return (
        pl.scan_csv("data/train/input*.csv")
        .select(
            "nfl_id",
            "player_name",
            "player_height",
            "player_weight",
            "player_position",
            "player_side",
        )
        .unique()
        .collect()
    )


def get_supplementary_data():
    return pl.read_csv(
        "data/supplementary_data.csv", null_values=["NA", "N/A", ""]
    ).with_columns(
        distance_to_goal=pl.when(pl.col("yardline_side") == pl.col("possession_team"))
        .then(100 - pl.col("yardline_number"))
        .otherwise(pl.col("yardline_number"))
    )


def get_tracking_output():
    return pl.read_csv(
        "data/train/output_*.csv", null_values=["NA", "nan", "N/A", "NaN", ""]
    )


def get_tracking_input():
    return pl.read_csv(
        "data/train/input_*.csv",
        quote_char='"',
        null_values=["NA", "nan", "N/A", "NaN", ""],
    ).join(
        get_supplementary_data().select(["game_id", "play_id", "distance_to_goal"]),
        on=["game_id", "play_id"],
    )


def convert_tracking_to_cartesian(tracking_df):
    return (
        tracking_df.with_columns(
            dir=((pl.col("dir") - 90) * -1) % 360,
            o=((pl.col("o") - 90) * -1) % 360,
        )
        # convert polar vectors to cartesian ((s, dir) -> (vx, vy), (o) -> (ox, oy))
        .with_columns(
            vx=pl.col("s") * pl.col("dir").radians().cos(),
            vy=pl.col("s") * pl.col("dir").radians().sin(),
            ox=pl.col("o").radians().cos(),
            oy=pl.col("o").radians().sin(),
        )
    )


def standardize_tracking_directions(tracking_df):

    df = tracking_df.with_columns(
        x=pl.when(pl.col("play_direction") == "right")
        .then(pl.col("x"))
        .otherwise(110 - pl.col("x")),
        y=pl.when(pl.col("play_direction") == "right")
        .then(pl.col("y"))
        .otherwise(53.3 - pl.col("y")),
    ).with_columns(
        x=pl.col("x") - (110 - pl.col("distance_to_goal"))
    )

    if "ball_land_x" in df.columns:
        df = convert_tracking_to_cartesian(df)
        df = df.with_columns(
            ball_land_x=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("ball_land_x"))
            .otherwise(110 - pl.col("ball_land_x")),
            ball_land_y=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("ball_land_y"))
            .otherwise(53.3 - pl.col("ball_land_y")),
            vx=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("vx"))
            .otherwise(pl.col("vx") * -1),
            vy=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("vy"))
            .otherwise(pl.col("vy") * -1),
            ox=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("ox"))
            .otherwise(pl.col("ox") * -1),
            oy=pl.when(pl.col("play_direction") == "right")
            .then(pl.col("oy"))
            .otherwise(pl.col("oy") * -1),
        )

    return df


def join_tracking_data():
    df_input = get_tracking_input()
    df_output = get_tracking_output()

    df_input = standardize_tracking_directions(df_input).drop(['player_name', 'player_position', 'player_side', "player_height", "player_weight"])

    df_output = standardize_tracking_directions(
        df_output.join(
            df_input.select(
                ["game_id", "play_id", "nfl_id", "play_direction", "distance_to_goal"]
            ).unique(),
            on=["game_id","play_id", "nfl_id"],
        )
    )
    df = (
        pl.concat(
            [
                df_input.with_columns(dataset=pl.lit("X")),
                df_output.with_columns(dataset=pl.lit("Y")),
            ],
            how="diagonal",
        )
    ).join(get_player_data(), on=['nfl_id'])


    return df


def add_tracking_features(tracking_df):
    return (
        tracking_df.sort(["game_id", "play_id", "nfl_id", "dataset", "frame_id"])
        .with_columns(
            frame_id=pl.row_index().over(
                ["game_id", "play_id", "nfl_id"], order_by=["dataset", "frame_id"]
            )
        )
        .with_columns(
            dx=pl.col("x")
            - (
                pl.col("x")
                .shift(1)
                .over(["game_id", "play_id", "nfl_id"], order_by="frame_id")
            ),
            dy=pl.col("y")
            - (
                pl.col("y")
                .shift(1)
                .over(["game_id", "play_id", "nfl_id"], order_by="frame_id")
            ),
            dt=pl.lit(1 / 10),
        )
        .with_columns(vvx=pl.col("dx") / pl.col("dt"), vvy=pl.col("dy") / pl.col("dt"))
        .with_columns(s=(pl.col("vvx") ** 2 + pl.col("vvy") ** 2).sqrt())
        .with_columns(s_mph=pl.col("s") * (3600 / 1760))
        .with_columns(
            turn_angle=(
                pl.arctan2(
                    pl.col("y")
                    .shift(-1)
                    .over(
                        ["game_id", "play_id", "nfl_id", "dataset"], order_by="frame_id"
                    )
                    - pl.col("y"),
                    pl.col("x")
                    .shift(-1)
                    .over(
                        ["game_id", "play_id", "nfl_id", "dataset"], order_by="frame_id"
                    )
                    - pl.col("x"),
                )
                - pl.arctan2(
                    pl.col("y")
                    - pl.col("y")
                    .shift(1)
                    .over(["game_id", "play_id", "nfl_id"], order_by="frame_id"),
                    pl.col("x")
                    - pl.col("x")
                    .shift(1)
                    .over(["game_id", "play_id", "nfl_id"], order_by="frame_id"),
                )
            )
        )
        .with_columns(
            turn_angle=pl.when(
                (pl.col("turn_angle") > 3.14) | (pl.col("turn_angle") < -3.14)
            )
            .then(0)
            .otherwise(pl.col("turn_angle"))
        )
        .with_columns(prev_angle=pl.col("turn_angle").shift(1))
        .drop(["vvx", "vvy", "dt"])
    )


def main():
    df = join_tracking_data()
    df = add_tracking_features(df)

    return df

df = main()
```


Distances

```{python}
def get_play_starts(df):
    return (
        df.filter(
            pl.all_horizontal(
                pl.col("player_side") == "Offense",
                pl.col("player_position") != "QB",
                pl.col("s") > 1,
            )
        )
        .group_by(["game_id", "play_id", "nfl_id"])
        .agg(pl.col("frame_id").min())
        .group_by(["game_id", "play_id"])
        .agg(frame_start=pl.col("frame_id").max())
    )


def get_distances(df):

    play_starts = get_play_starts(df)

    cols = [
        "game_id",
        "play_id",
        "nfl_id",
        "frame_id",
        "player_to_predict",
        "player_position",
        "player_side",
        "player_role",
        "x",
        "y",
        "o",
        "dir",
        "vx",
        "vy",
        "ox",
        "oy",
        "s",
        "s_mph",
    ]

    df_offense = (
        df.join(play_starts, on=["game_id", "play_id"], how="inner")
        .filter(
            pl.all_horizontal(
                pl.col("player_side") == "Offense",
                pl.col("dataset") == "X",
                pl.col("player_position") != "QB",
                #pl.col("frame_id") > pl.col("frame_start"),
            )
        )
        .select(cols)
    )

    df_defense = df.filter(
        pl.all_horizontal(
            pl.col("player_side") == "Defense",
            pl.col("dataset") == "X",
            pl.col("player_position").is_in(["CB", "S", "SS", "ILB", "FS", "LB", "OLB"]),
        )
    ).select(cols)

    return df_offense.join(
        df_defense, on=["game_id", "play_id", "frame_id"], suffix="_def"
    ).with_columns(
        distance=(
            (pl.col("x") - pl.col("x_def")).pow(2)
            + (pl.col("y") - pl.col("y_def")).pow(2)
        ).sqrt()
    )

df_distances = get_distances(df)
```


### GMM


```{python}

over_cols = ["game_id", "play_id", "nfl_id", "nfl_id_def"]

df_model = (
    df_distances.with_columns(
        min_dist=pl.min("distance").over(["game_id", "play_id", "nfl_id", "nfl_id_def"])
    )
    # .filter(pl.col("min_dist") <= 12)
    .with_columns(y=pl.col("y") - (53.3 / 2), y_def=pl.col("y_def") - (53.3 / 2))
    .sort(by=over_cols + ["frame_id"])
    .with_columns(
        dist_change=(pl.col("distance") - pl.col("distance").shift(1)).abs(),
        min_dist_last_5=pl.col("distance").rolling_min(5).over(over_cols),
        delta_x=pl.col("x_def") - pl.col("x"),
        delta_y=pl.col("y_def") - pl.col("y"),
        mag_receiver=(pl.col("vx") ** 2 + pl.col("vy") ** 2).sqrt(),
        mag_defender=(pl.col("vx_def") ** 2 + pl.col("vy_def") ** 2).sqrt(),
        dot_prod=pl.col("vx") * pl.col("vx_def") + pl.col("vy") * pl.col("vy_def"),
    )
    .with_columns(
        velocity_alignment=pl.col("dot_prod")
        / (pl.col("mag_receiver") * pl.col("mag_defender")),
    ).select(
        [
            "game_id", "play_id", "frame_id", "nfl_id", "nfl_id_def",
            "distance",
            "dist_change",
            "min_dist_last_5",
            "delta_x",
            "delta_y",
            "velocity_alignment",
        ]
    ).drop_nulls().drop_nans()
)
```


```{python}
from sklearn.mixture import GaussianMixture
from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()
X = scaler.fit_transform(
    df_model.drop(["game_id", "play_id", "frame_id", "nfl_id", "nfl_id_def"])
)


gm = GaussianMixture(n_components=2, random_state=52723).fit(X)

player_data = get_player_data()

mike_evans = pl.concat([df_model, pl.from_numpy(gm.predict_proba(X))], how="horizontal").filter(
    pl.col("game_id") == 2023091706, pl.col('play_id') == 2583
).filter(
    pl.col('nfl_id') == 41233
).join(
    player_data.select('nfl_id', 'player_name'),
    left_on = ['nfl_id_def'], right_on = 'nfl_id'
)

from plotnine import *

(
ggplot(data = mike_evans, mapping= aes(x='frame_id')) + geom_line(aes(y='column_0'), color='blue') + geom_line(aes(y='column_1',) ,color='red') + facet_wrap(['player_name'])
)


plot_df = df.filter(
    pl.col("game_id") == 2023091706, pl.col('play_id') == 2583
)

(
ggplot(data = plot_df, mapping = aes(x='x', y='y', color='dataset')) + geom_point() + geom_text(data = plot_df.filter(pl.col('frame_id') == pl.col('frame_id').min()), mapping=aes(x='x', y='y', label='player_name'), color='black')
)
```
