
```{python}

import polars as pl
import duckdb
import numpy as np
```


```{python}
from analytics.src.prep_data import main, get_player_data
#df = main()
player_data = get_player_data()
#df.write_parquet('analytics/prepped_data.parquet')
```



### GMM


```{python}
from plotnine import *

def get_coverage_assignments_data():
    return pl.scan_parquet('analytics/model_data/coverage_assignments.parquet')

def create_plot_df(df, play):
    if isinstance(df, pl.DataFrame):
        return df.join(play, on=["game_id", "play_id"])

    if isinstance(df, pl.LazyFrame):
        return (
            df.join(play.lazy(), on=['game_id', "play_id"])
            .collect()
        )

    if isinstance(df, str):
        return (
            pl.scan_parquet(df)
            .join(play.lazy(), on=["game_id", "play_id"])
            .collect()
        )


def create_tracking_plot(df, play):
    plot_df = create_plot_df(df, play)
    return (
        ggplot(data=plot_df, mapping=aes(x="x", y="y", color="dataset"))
        + geom_point(aes(alpha="frame_id"))
        + geom_text(
            data=plot_df.filter(pl.col("frame_id") == pl.col("frame_id").min()),
            mapping=aes(x="x", y="y", label="player_name"),
            color="black",
        )
    )


def create_player_prob_plot(player_df):
    return (
        ggplot(data=player_df, mapping=aes(x="frame_id"))
        + geom_line(aes(y="column_0"), color="blue")
        + geom_line(
            aes(
                y="column_1",
            ),
            color="red",
        )
        + facet_wrap(["player_name_def"])
    )


def create_player_df(df, player_name):

    return df.filter(pl.col("player_name") == player_name)

```

## Mike Evans

```{python}
df_preds = get_coverage_assignments_data()

df = "analytics/prepped_data/combined_tracking.parquet"
play = pl.DataFrame({"game_id": 2023091706, "play_id": 2583})

mike_evans = create_player_df(create_plot_df(df_preds, play), "Mike Evans")

create_tracking_plot(df, play)
create_player_prob_plot(mike_evans)

```


### Josh Reynolds

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 101})

josh_reynolds = create_player_df(create_plot_df(df_preds, play), "Josh Reynolds")

create_tracking_plot(df, play)
create_player_prob_plot(josh_reynolds)

```

### Trent Sherfield

```{python}
play = pl.DataFrame({"game_id": 2023092408, "play_id": 1574})

trent_sherfield = create_player_df(create_plot_df(df_preds, play), "Trent Sherfield")

create_tracking_plot(df, play)
create_player_prob_plot(trent_sherfield)

```

## Chase claypool
```{python}
play = pl.DataFrame({"game_id": 2023091706, "play_id": 3512})

chase_claypool = create_player_df(create_plot_df(df_preds, play), "Chase Claypool")

create_tracking_plot(df, play)
create_player_prob_plot(chase_claypool)

```


```{python}
play = pl.DataFrame({"game_id": 2023091706, "play_id": 3512})

cole_kmet = create_player_df(create_plot_df(df_preds, play), "Cole Kmet")

create_tracking_plot(df, play)
create_player_prob_plot(cole_kmet)
```


## Marvin Jones 2X

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 361})
marvin_jones = create_player_df(create_plot_df(df_preds, play), "Marvin Jones")

create_tracking_plot(df, play)
create_player_prob_plot(marvin_jones)
```






## Josh Downs - Goal Line

```{python}

play = pl.DataFrame({"game_id": 2023101506, "play_id": 3367})

josh_downs = create_player_df(create_plot_df(df_preds, play), "Josh Downs")

create_tracking_plot(df, play)
create_player_prob_plot(josh_downs)

```

## Big Mike - Shadow Realm

This might be cause to round up if the p > 0.5

```{python}
play = pl.DataFrame({"game_id": 2023092406, "play_id": 2741})

big_mike = create_player_df(create_plot_df(df_preds, play), "Mike Williams")

create_tracking_plot(df, play)
create_player_prob_plot(big_mike)

```


## Jonathan Mingo

```{python}
play = pl.DataFrame({"game_id": 2023091800, "play_id": 2500})

jonathan_mingo = create_player_df(create_plot_df(df_preds, play), "Jonathan Mingo")

create_tracking_plot(df, play)
create_player_prob_plot(jonathan_mingo)

```



```{python}
play = pl.DataFrame({"game_id": 2023091710, "play_id": 3659})

garrett_wilson = create_player_df(create_plot_df(df_preds, play), "Garrett Wilson")

create_tracking_plot(df, play)
create_player_prob_plot(garrett_wilson)

```

## Joining together


```{python}
df_preds.head().collect().glimpse()


grouping_cols = ["game_id", "play_id", "nfl_id", "nfl_id_def"]

df_assignments = (
    df_preds
    .select(grouping_cols + ["frame_id", pl.col("column_0").alias("pred_coverage")])
)

```


Turn angle def isn't joining to anything in the early frames

```{python}

df_combined_tracking = pl.scan_parquet(
    "analytics/prepped_data/combined_tracking.parquet"
)


players = (
    df_combined_tracking.filter(
        pl.col("player_position").is_in(
            ["WR", "CB", "S", "SS", "ILB", "FS", "LB", "OLB", "MLB"]
        )
    )
    .select(["game_id", "play_id", "frame_id", "nfl_id", "player_name", "player_side"])
    .unique()
)

pairs = players.join(
    players, on=["game_id", "play_id", "frame_id"], how="inner", suffix="_def"
).filter(
    pl.all_horizontal(pl.col("player_side") != "Defense"),
    pl.col("player_side") != pl.col("player_side_def"),
)


df_model_stg = (
    pairs#.join(play.lazy(), on=["game_id", "play_id"])
    .join(
        df_assignments.select(
            ["game_id", "play_id", "frame_id", "nfl_id", "nfl_id_def", "pred_coverage"]
        ),
        left_on=["game_id", "play_id", "frame_id", "nfl_id", "nfl_id_def"],
        right_on=["game_id", "play_id", "frame_id", "nfl_id", "nfl_id_def"],
        how="left",
    )
    .filter(
        pl.col("pred_coverage")
        .max()
        .over(["game_id", "play_id", "nfl_id", "nfl_id_def"])
        > 0.1
    )
    .sort(["game_id", "play_id", "player_name", "nfl_id", "frame_id"])
    .with_columns(
        pred_coverage=pl.col("pred_coverage")
        .fill_null(strategy="forward")
        .over(["game_id", "play_id", "nfl_id", "nfl_id_def"], order_by="frame_id")
    )
    .with_columns(
        pred_coverage=pl.col("pred_coverage")
        .rolling_mean(2)
        .over(["game_id", "play_id", "nfl_id", "nfl_id_def"], order_by="frame_id")
    )
    .with_columns(pred_coverage=pl.col("pred_coverage").fill_null(value=0))
)


tracking_cols = [
    "game_id",
    "play_id",
    "frame_id",
    "nfl_id",
    "x",
    "y",
    "turn_angle",
    "prev_angle",
    "vx",
    "vy",
]

over_cols = ["game_id", "play_id", "nfl_id", "nfl_id_def"]


df_model = (
    df_model_stg.join(
        df_combined_tracking.select(tracking_cols),
        on=["game_id", "play_id", "nfl_id", "frame_id"],
    )
    .join(
        df_combined_tracking.select(tracking_cols),
        left_on=["game_id", "play_id", "nfl_id_def", "frame_id"],
        right_on=["game_id", "play_id", "nfl_id", "frame_id"],
        suffix="_def",
    )
    .with_columns(
        vx=pl.col("x").diff().over(over_cols, order_by="frame_id") / 0.1,
        vy=pl.col("y").diff().over(over_cols, order_by="frame_id") / 0.1,
        vx_def=pl.col("x_def").diff().over(over_cols, order_by="frame_id") / 0.1,
        vy_def=pl.col("y_def").diff().over(over_cols, order_by="frame_id") / 0.1,
    )
    .with_columns(
        diff_turn_angle=pl.arctan2(
            (pl.col("turn_angle") - pl.col("turn_angle_def")).sin(),
            (pl.col("turn_angle") - pl.col("turn_angle_def")).cos(),
        )
        .over(over_cols, order_by="frame_id")
        .round(3)
    )
    .with_columns(
        diff_turn_angle_coverage=pl.col("diff_turn_angle") * pl.col("pred_coverage")
    )
    .collect()
)


```


```{python}

new_play = (
    df_model.filter(pl.col("diff_turn_angle_coverage").abs() > 1.5)
    .sample(1)
    .select(["game_id", "play_id", "player_name", "diff_turn_angle_coverage"])
)


play = pl.DataFrame({"game_id": 2023121400, "play_id": 3746})

create_tracking_plot(df, new_play)


pl.scan_csv("data/supplementary_data.csv").select(
    "game_id",
    "week",
    "play_id",
    "quarter",
    "down",
    "play_description",
    "home_team_abbr",
    "visitor_team_abbr",
    "game_clock",
    "yards_to_go",
).join(new_play.lazy(), on=["game_id", "play_id"]).collect()

(
    ggplot(
        df_model.join(new_play, on=["game_id", "play_id", "player_name"])
        .select(
            [
                "frame_id",
                "player_name_def",
                "turn_angle",
                "turn_angle_def",
                "diff_turn_angle",
                "diff_turn_angle_coverage",
                # "pred_coverage",
            ]
        )
        .unpivot(index=["frame_id", "player_name_def"]),
        aes("frame_id", "value", color="variable"),
    )
    + geom_line()
    + facet_wrap("player_name_def", ncol=1)
    + scale_color_manual(values=["blue", "red", "grey", "grey"])
)
```
