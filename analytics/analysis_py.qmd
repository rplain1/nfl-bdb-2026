
```{python}

import polars as pl
import duckdb
import numpy as np
```


```{python}
from analytics.src.prep_data import main, get_player_data
#df = main()
player_data = get_player_data()
#df.write_parquet('analytics/prepped_data.parquet')
```



### GMM


```{python}
from plotnine import *

def get_coverage_assignments_data():
    return pl.scan_parquet('analytics/model_data/coverage_assignments.parquet')

def create_plot_df(df, play):
    if isinstance(df, pl.DataFrame):
        return df.join(play, on=["game_id", "play_id"])

    if isinstance(df, pl.LazyFrame):
        return (
            df.join(play.lazy(), on=['game_id', "play_id"])
            .collect()
        )

    if isinstance(df, str):
        return (
            pl.scan_parquet(df)
            .join(play.lazy(), on=["game_id", "play_id"])
            .collect()
        )


def create_tracking_plot(df, play):
    plot_df = create_plot_df(df, play)
    return (
        ggplot(data=plot_df, mapping=aes(x="x", y="y", color="dataset"))
        + geom_point(aes(alpha="frame_id"))
        + geom_text(
            data=plot_df.filter(pl.col("frame_id") == pl.col("frame_id").min()),
            mapping=aes(x="x", y="y", label="player_name"),
            color="black",
        )
    )


def create_player_prob_plot(player_df):
    return (
        ggplot(data=player_df, mapping=aes(x="frame_id"))
        + geom_line(aes(y="column_0"), color="blue")
        + geom_line(
            aes(
                y="column_1",
            ),
            color="red",
        )
        + facet_wrap(["player_name_def"])
    )


def create_player_df(df, player_name):

    return df.filter(pl.col("player_name") == player_name)

```

## Mike Evans

```{python}
df_preds = get_coverage_assignments_data()

df = "analytics/prepped_data/combined_tracking.parquet"
play = pl.DataFrame({"game_id": 2023091706, "play_id": 2583})

mike_evans = create_player_df(create_plot_df(df_preds, play), "Mike Evans")

create_tracking_plot(df, play)
create_player_prob_plot(mike_evans)

```


### Josh Reynolds

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 101})

josh_reynolds = create_player_df(create_plot_df(df_preds, play), "Josh Reynolds")

create_tracking_plot(df, play)
create_player_prob_plot(josh_reynolds)

```

### Trent Sherfield

```{python}
play = pl.DataFrame({"game_id": 2023092408, "play_id": 1574})

trent_sherfield = create_player_df(create_plot_df(df_preds, play), "Trent Sherfield")

create_tracking_plot(df, play)
create_player_prob_plot(trent_sherfield)

```

## Chase claypool
```{python}
play = pl.DataFrame({"game_id": 2023091706, "play_id": 3512})

chase_claypool = create_player_df(create_plot_df(df_preds, play), "Chase Claypool")

create_tracking_plot(df, play)
create_player_prob_plot(chase_claypool)

```

## Marvin Jones 2X

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 361})
marvin_jones = create_player_df(create_plot_df(df_preds, play), "Marvin Jones")

create_tracking_plot(df, play)
create_player_prob_plot(marvin_jones)
```


## Josh Downs - Goal Line

```{python}

play = pl.DataFrame({"game_id": 2023101506, "play_id": 3367})

josh_downs = create_player_df(create_plot_df(df_preds, play), "Josh Downs")

create_tracking_plot(df, play)
create_player_prob_plot(josh_downs)

```

## Big Mike - Shadow Realm

This might be cause to round up if the p > 0.5

```{python}
play = pl.DataFrame({"game_id": 2023092406, "play_id": 2741})

big_mike = create_player_df(create_plot_df(df_preds, play), "Mike Williams")

create_tracking_plot(df, play)
create_player_prob_plot(big_mike)

```


## Jonathan Mingo

```{python}
play = pl.DataFrame({"game_id": 2023091800, "play_id": 2500})

jonathan_mingo = create_player_df(create_plot_df(df_preds, play), "Jonathan Mingo")

create_tracking_plot(df, play)
create_player_prob_plot(jonathan_mingo)

```



```{python}
play = pl.DataFrame({"game_id": 2023091710, "play_id": 3659})

garrett_wilson = create_player_df(create_plot_df(df_preds, play), "Garrett Wilson")

create_tracking_plot(df, play)
create_player_prob_plot(garrett_wilson)

```

## Joining together


```{python}
df_preds.head().collect().glimpse()


grouping_cols = ["game_id", "play_id", "nfl_id", "nfl_id_def"]

df_assignments = (
    df_preds.with_columns(
        is_coverage_assigned=pl.col("column_1").max().over(grouping_cols)
    )
    # .filter(pl.col("is_coverage_assigned") > 0.5)
    .select(grouping_cols + ["frame_id", pl.col("column_0").alias("pred_coverage")])
)

```


Steps

- take the assignment data and join what?

combined tracking: long, player level
assignment: wider, receiver/defender level

I can left join combined tracking offense, and then join combined tracking defense.
- this will still only give me the X dataset plays.

Okay! so player_to_predict only appears in the X dataset.  I could filter combined tracking to where player_to_preict max over nfl_id, game_id, play_id is True.

```{python}

df_combined_tracking = pl.scan_parquet('analytics/prepped_data/combined_tracking.parquet')

players_to_predict = df_combined_tracking.with_columns(keep_y = pl.col('player_to_predict').max().over(['game_id', 'play_id', 'nfl_id'])).filter(pl.col('keep_y') == True)




tmp = (
    df_combined_tracking.filter(
        pl.col("player_position").is_in(["WR", "TE", "RB"]),
    )
    .join(
        df_assignments.lazy().select(
            [
                "game_id",
                "play_id",
                "frame_id",
                "nfl_id",
                "nfl_id_def",
                "pred_coverage",
            ]
        ),
        on=["game_id", "play_id", "nfl_id", "frame_id"],
        how="full",
    )
    .join(play.lazy(), on=["game_id", "play_id"])
    .collect()
)
.with_columns(
    nfl_id_def=pl.col("nfl_id_def")
    .fill_null(strategy="forward")
    .over(["game_id", "play_id", "nfl_id"], order_by="frame_id"),
).with_columns(
    pred_coverage=pl.col("pred_coverage")
    .fill_null(strategy="forward")
    .over(["game_id", "play_id", "nfl_id", "nfl_id_def"], order_by="frame_id")
).group_by(
    ["nfl_id", "nfl_id_def"]
).agg(
    pl.col("frame_id").max()
).sort('frame_id')
```









```{python}

df_combined_tracking = pl.scan_parquet(
    "analytics/prepped_data/combined_tracking.parquet"
)

(
    df_combined_tracking.filter(
        pl.col("player_position").is_in(["WR", "TE", "RB"]),
    )
    .join(
        df_assignments.lazy(),
        on=["game_id", "play_id", "nfl_id", "frame_id"],
        how="inner",
    )
    .collect()
)


df_assignments.join(play, on=["game_id", "play_id"])

"""
This gets the fill forward I want. It might be good to take the average of the last 3 frames and fill that forward?

Oh wut, this still isn't getting the right data
"""


df_assignments.join(play, on=["game_id", "play_id"]).select(
    [
        "game_id",
        "play_id",
        "frame_id",
        "nfl_id",
        "player_name",
        "nfl_id_def",
        "turn_angle",
        "pred_coverage",
    ]
).with_columns(
    nfl_id_def=pl.col("nfl_id_def")
    .fill_null(strategy="forward")
    .over(["game_id", "play_id", "nfl_id"], order_by="frame_id"),
).with_columns(
    pred_coverage=pl.col("pred_coverage")
    .fill_null(strategy="forward")
    .over(["game_id", "play_id", "nfl_id", "nfl_id_def"], order_by="frame_id")
).filter(
    pl.col("player_name") == "Mike Evans"
).filter(
    pl.col("nfl_id_def") == 54513  # 55921
)


### AHHH gotta figure out how to take the assignments and fill the probabilities here....

# .join(
#     df_combined_tracking.select(
#         "game_id", "play_id", "frame_id", "nfl_id", "player_name", "turn_angle"
#     ),
#     left_on=["game_id", "play_id", "frame_id", "nfl_id_def"],
#     right_on=["game_id", "play_id", "frame_id", "nfl_id"],
#     suffix="_def",
#     how = "left"
# ).collect()

# df_turn_angle = df_turn_angle.with_columns(
#     diff_turn_angle = pl.arctan2(
#         (pl.col("turn_angle") - pl.col("turn_angle_def")).sin(),
#         (pl.col("turn_angle") - pl.col("turn_angle_def")).cos(),
#     ).round(3)
# ).with_columns(
#     diff_turn_angle_coverage = pl.col('diff_turn_angle') * pl.col('pred_coverage')
# )
```


```{python}

play_starts = get_play_starts(create_plot_df(df, play))

player_df = create_plot_df(df_turn_angle, play).filter(pl.col('player_name') == 'Mike Evans').filter(pl.col('frame_id') > 8)

(
    ggplot(data=player_df, mapping=aes(x="frame_id"))
    + geom_line(aes(y="diff_turn_angle"), color="black", alpha = 0.7)
    # + geom_line(
    #     aes(
    #         y="diff_turn_angle_coverage",
    #     ),
    #     color="red", alpha = 0.7
    # )
    + facet_wrap(["player_name_def"])
)
```


```{python}
create_plot_df(df_turn_angle, play)
```




```{python}
tmp = create_plot_df(df, play).filter(
    pl.col("player_name").is_in(["Mike Evans", "Tyrique Stevenson"])
)
```
