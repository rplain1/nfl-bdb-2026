
```{python}

import polars as pl
import duckdb
import numpy as np
```


```{python}
from analytics.src.prep_data import main, get_player_data
#df = main()
player_data = get_player_data()
#df.write_parquet('analytics/prepped_data.parquet')
```



### GMM


```{python}
from plotnine import *

def get_coverage_assignments_data():
    return pl.scan_parquet('analytics/model_data/coverage_assignments.parquet')

def create_plot_df(df, play):
    if isinstance(df, pl.DataFrame):
        return df.join(play, on=["game_id", "play_id"])

    if isinstance(df, pl.LazyFrame):
        return (
            df.join(play.lazy(), on=['game_id', "play_id"])
            .collect()
        )

    if isinstance(df, str):
        return (
            pl.scan_parquet(df)
            .join(play.lazy(), on=["game_id", "play_id"])
            .collect()
        )


def create_tracking_plot(df, play):
    plot_df = create_plot_df(df, play)
    return (
        ggplot(data=plot_df, mapping=aes(x="x", y="y", color="dataset"))
        + geom_point()
        + geom_text(
            data=plot_df.filter(pl.col("frame_id") == pl.col("frame_id").min()),
            mapping=aes(x="x", y="y", label="player_name"),
            color="black",
        )
    )


def create_player_prob_plot(player_df):
    return (
        ggplot(data=player_df, mapping=aes(x="frame_id"))
        + geom_line(aes(y="column_0"), color="blue")
        + geom_line(
            aes(
                y="column_1",
            ),
            color="red",
        )
        + facet_wrap(["player_name_def"])
    )


def create_player_df(df, player_name):

    return df.filter(pl.col("player_name") == player_name)

```

## Mike Evans

```{python}
df_preds = get_coverage_assignments_data()

df = "analytics/prepped_data/combined_tracking.parquet"
play = pl.DataFrame({"game_id": 2023091706, "play_id": 2583})

mike_evans = create_player_df(create_plot_df(df_preds, play), "Mike Evans")

create_tracking_plot(df, play)
create_player_prob_plot(mike_evans)

```


### Josh Reynolds

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 101})

josh_reynolds = create_player_df(create_plot_df(df_preds, play), "Josh Reynolds")

create_tracking_plot(df, play)
create_player_prob_plot(josh_reynolds)

```

### Trent Sherfield

```{python}
play = pl.DataFrame({"game_id": 2023092408, "play_id": 1574})

trent_sherfield = create_player_df(create_plot_df(df_preds, play), "Trent Sherfield")

create_tracking_plot(df, play)
create_player_prob_plot(trent_sherfield)

```

## Chase claypool
```{python}
play = pl.DataFrame({"game_id": 2023091706, "play_id": 3512})

chase_claypool = create_player_df(create_plot_df(df_preds, play), "Chase Claypool")

create_tracking_plot(df, play)
create_player_prob_plot(chase_claypool)

```

## Marvin Jones 2X

```{python}
play = pl.DataFrame({"game_id": 2023090700, "play_id": 101})
josh_reynolds = create_player_df(create_plot_df(df_preds, play), "Josh Reynolds")

create_tracking_plot(df, play)
create_player_prob_plot(josh_reynolds)
```


## Josh Downs - Goal Line

```{python}

play = pl.DataFrame({"game_id": 2023101506, "play_id": 3367})

josh_downs = create_player_df(create_plot_df(df_preds, play), "Josh Downs")

create_tracking_plot(df, play)
create_player_prob_plot(josh_downs)

```

## Big Mike - Shadow Realm

This might be cause to round up if the p > 0.5

```{python}
play = pl.DataFrame({"game_id": 2023092406, "play_id": 2741})

big_mike = create_player_df(create_plot_df(df_preds, play), "Mike Williams")

create_tracking_plot(df, play)
create_player_prob_plot(big_mike)

```


## Joining together


```{python}
df_preds.head().collect().glimpse()


grouping_cols = ["game_id", "play_id", "nfl_id", "nfl_id_def"]

df_assignments = (
    df_preds.with_columns(
        is_coverage_assigned=pl.col("column_1").max().over(grouping_cols)
    )
    .filter(pl.col("is_coverage_assigned") > 0.5)
    .select(grouping_cols + ["frame_id", pl.col("column_1").alias("pred_coverage")])
    .collect()
)

df_assignments.write_parquet('analytics/model_data/coverage_assignments_filtered.parquet')
```


```{python}

df_combined_tracking = pl.scan_parquet(
    "analytics/prepped_data/combined_tracking.parquet"
)

df_assignments = pl.scan_parquet(
    "analytics/model_data/coverage_assignments_filtered.parquet"
)

df_turn_angle = df_combined_tracking.filter(
    pl.col("player_position").is_in(["WR", "TE", "RB"]),
).join(
    df_assignments,
    on=["game_id", "play_id", "nfl_id", "frame_id"],
    how="inner",
).join(
    df_combined_tracking.select(
        "game_id", "play_id", "frame_id", "nfl_id", "player_name", "turn_angle"
    ),
    left_on=["game_id", "play_id", "frame_id", "nfl_id_def"],
    right_on=["game_id", "play_id", "frame_id", "nfl_id"],
    suffix="_def",
).collect()

df_turn_angle = df_turn_angle.with_columns(
    diff_turn_angle = pl.arctan2(
        (pl.col("turn_angle") - pl.col("turn_angle_def")).sin(),
        (pl.col("turn_angle") - pl.col("turn_angle_def")).cos(),
    ).round(3)
).with_columns(
    diff_turn_angle_coverage = pl.col('diff_turn_angle') * pl.col('pred_coverage')
)
```


```{python}
player_df = create_plot_df(df_turn_angle, play).filter(pl.col('player_name') == 'Mike Evans')

(
    ggplot(data=player_df, mapping=aes(x="frame_id"))
    + geom_line(aes(y="diff_turn_angle"), color="blue")
    + geom_line(
        aes(
            y="diff_turn_angle_coverage
            ",
        ),
        color="red",
    )
    + facet_wrap(["player_name_def"])
)
```




```{python}
tmp = create_plot_df(df, play).filter(
    pl.col("player_name").is_in(["Mike Evans", "Tyrique Stevenson"])
)
```
