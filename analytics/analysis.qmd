---
title: "Untitled"
format: html
code-fold: true
execute:
  warning: false
  message: false
---


```{r}
library(tidyverse)

library(patchwork)
source('analytics/prep_data.R')
player_data <- get_player_data()
sup_data <- tbl(con, "supplementary_data") |> collect()
```

Understanding turn angle difference

```{r}

angles <- seq(-pi, pi, length.out = 100)

crossing(angles, angles) |>
  `colnames<-`(c('x1', 'x2')) |>
  mutate(
    diff_raw = x1 - x2, # plain subtraction
    diff_wrapped = atan2(
      sin(x1 - x2),
      cos(x1 - x2)
    ) # circular (wrapped) difference
  ) |>
  pull(diff_wrapped) |>
  summary()

```



```{r}

create_plot_df <- function(.data, play) {
  .data |>
    inner_join(play) |>
    inner_join(player_data) |>
    mutate(
      .color = case_when(
        dataset == 'X' & player_side == 'Offense' ~ 'blue',
        dataset == 'X' & player_side == 'Defense' ~ 'red',
        dataset == 'Y' ~ 'green',
        TRUE ~ NA
      )
    )
}

get_distance <- function(.data, player_names) {
  .data |>
    filter(player_name %in% player_names) |>
    summarize(
      distance = sqrt(diff(x)^2 + diff(y)^2),
      .by = frame_id2
    )
}

```

## Quick Win

Zone coverage, but the receiver makes a quick move on the linebacker that frees him up for the pass.

It's somewhat clear with the angle the defender takes in the aerial view, and the turn angle plot shows where the delta occurs.

```{r}
df_week <- prep_data(con, week = 2:3)
play <- tribble(
  ~game_id   , ~play_id ,
  2023092408 ,     1574
)

plot_df <- df_week |> create_plot_df(play)

plot_df |>
  #inner_join(tbl(con, "play_starts") |> collect()) |>
  filter(frame_id >= 6) |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

player_names <- c('Benjamin St-Juste', 'Trent Sherfield')
player_names <- c('Dalton Kincaid', 'Jamin Davis')


plot_df |>
  inner_join(tbl(con, "play_starts") |> collect()) |>
  filter(player_name %in% player_names) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()


plot_df |>
  get_distance(player_names) |>
  ggplot(aes(frame_id2, distance)) +
  geom_point() +
  geom_line()

```

### Mike Evans win

Looking at a Mike Evans long TD, it looks like there is little seperation - but he clearly opens up a window before the ball is thrown.

```{r}
df_week <- prep_data(con, week=2:3)
play <- tribble(
  ~game_id   , ~play_id ,
  2023091706 ,     2583
)

plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)




p1 <- plot_df |>
  filter(player_name %in% c('Mike Evans', 'Tyrique Stevenson')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  #left_join(dist_df) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line() +
  #geom_line(aes(y=distance), data = dist_df, color='black') +
  geom_vline(xintercept = 28) +
  annotate("text", x = 30.5, y = 0.5, label = 'ball thrown') +
  annotate(
    "segment",
    x = 21,
    xend = 23.5,
    y = 0.5,
    yend = 0.25,
    arrow = arrow(length = unit(0.3, "cm"))
  ) +
  annotate("text", x = 20, y = 0.56, label = 'separation')


p2 <- plot_df |>
  filter(player_name %in% c('Mike Evans', 'Tyrique Stevenson')) |>
  summarize(
    distance = sqrt(diff(x)^2 + diff(y)^2),
    .by = frame_id2
  ) |>
  ggplot(aes(frame_id2, distance)) +
  geom_line() +
  geom_point() +
  geom_vline(xintercept = 28) +
  geom_vline(xintercept = 24, linetype = 'dashed')


p1 / p2
```


```{r}
defenders_df <- plot_df |>
  filter(player_side == "Defense") |> # adjust filter as needed
  select(frame_id2, defender_name = player_name, def_x = x, def_y = y)

offensive_df <- plot_df |>
  mutate(max_frame_id = max(frame_id2)) |>
  filter(frame_id2 >= max_frame_id / 2) |>
  filter(player_side == "Offense") |>
  select(frame_id2, player_name, off_x = x, off_y = y)

# Calculate all pairwise distances
distances <- offensive_df |>
  inner_join(defenders_df, by = "frame_id2", relationship = "many-to-many") |>
  mutate(
    distance = sqrt((off_x - def_x)^2 + (off_y - def_y)^2)
  )

# Tag closest defender
closest_defenders <- distances |>
  slice_min(distance, n = 1, by = c(frame_id2, player_name)) |>
  select(
    frame_id2,
    player_name,
    closest_defender = defender_name,
    min_distance = distance
  )

closest_defenders |>
  count(player_name, closest_defender) |>
  group_by(player_name) |>
  mutate(rn = rank(-n)) |>
  ungroup() |>
  filter(rn == 1)

# Join back to original data
plot_df |>
  left_join(closest_defenders, by = c("frame_id2", "player_name"))
```








### Michael Pittman - Quick Win

Another quick win, this type specifically against man coverage.

```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023092400 ,     1460
)

df_week <- prep_data(con, 2:3)
plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  filter(player_name %in% c('Michael Pittman', 'Ronald Darby')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = 20) +
  annotate("text", x = 21.5, y = 0.25, label = 'ball thrown') +
  annotate(
    "segment",
    x = 15,
    xend = 17,
    y = 0,
    yend = -0.1,
    arrow = arrow(length = unit(0.3, "cm"))
  ) +
  annotate("text", x = 14, y = 0.02, label = 'separation')

```


## Incomplete Pass - Jonathan Mingo Deep Ball

Deep ball, without any turn angle seperation. Incomplete pass.

```{r}


play <- tribble(
  ~game_id   , ~play_id ,
  2023091800 ,     2500
)


plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)


plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Jonathan Mingo', 'Paulson Adebo')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()
```


## Garrett Wilson Deep Ball - No Turn Angle Seperation

Another deep ball, trying to win on speed alone.

```{r}


play <- tribble(
  ~game_id   , ~play_id ,
  2023091710 ,     3659
)


plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Garrett Wilson', 'Trevon Diggs')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()
```

## Mike Williams - Shadow Realm

Inconplete pass, but Mike Williams cooked him on the other side.

```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023092406 ,     2741
)


plot_df <- df_week |> create_plot_df(play)

plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Mike Williams', 'Byron Murphy')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  summarize(
    turn_angle = sqrt(diff(turn_angle)^2 + diff(turn_angle)^2),
    .by = frame_id2
  ) |>
  ggplot(aes(frame_id2, turn_angle)) +
  # ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()



```


## Chase Claypool TD

Chase Claypool does a double move that opens up a window. Also sparks an idea, Justin Fields waited for this window to open. There was also herbert missing a window. Could I look at QB efficiency in finding the windows? Maybe hard for that because we don't know where he is looking except roughly with orientation. There might be something with conditioning on a target, does he hit the window early or late. i.e. throwing with anticipation vs without it

```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023091706 ,     3512
)


plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Chase Claypool', 'Jamel Dean')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = 31) +
  annotate("text", x = 32.5, y = 0.25, label = 'ball thrown')

```



## Long Play: 83 - 6 = 7.7 seconds


```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023100809 ,     3216
)

sup_data |> inner_join(play)
df_week <- prep_data(con, 5)
plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
#  filter(player_name %in% c('Adam Trautman', 'C.J. Mosley')) |>

  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>

  filter(player_name %in% c('Adam Trautman', 'C.J. Mosley')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = 75) +
  annotate("text", x = 75.5, y = 0.25, label = 'ball thrown')


```

### Screen Play, shouldn't be used

```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023100807 ,      4264
)

df_week <- prep_data(con, week = 5)

plot_df <- df_week |> create_plot_df(play)


plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Ko Kieft', 'Akayleb Evans')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()


plot_df |>
  filter(frame_id2 > 2) |>
  filter(player_name %in% c('Chris Godwin Jr.', 'Harrison Smith')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()
```



## Tackle in route?

okay... this was true
```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023091705 ,      292
)
df_week <- prep_data(con, week = 2)
plot_df <- df_week |> create_plot_df(play)

plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)
```

## Marvin Jones gets defender out of position twice.


```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023090700 ,      361
)
week <- sup_data |> inner_join(play) |> pull(week)
df_week <- prep_data(con, week = week)
plot_df <- df_week |> create_plot_df(play)

plot_df |>
  ungroup() |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = .color,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black') +
  geom_vline(xintercept = 0)

plot_df |>
  left_join(tbl(con, "play_starts") |> collect()) |>
  filter(frame_id2 >= frame_start) |>
  filter(player_name %in% c('Marvin Jones', 'Justin Reid')) |>
  select(player_name, frame_id2, x, y, dir, turn_angle) |>
  ggplot(aes(frame_id2, turn_angle, color = player_name)) +
  geom_point() +
  geom_line()
```


```{r}
play <- tribble(
  ~game_id   , ~play_id ,
  2023090700 ,     194
)
week <- sup_data |> inner_join(play) |> pull(week)
df_week <- prep_data(con, week = week)
plot_df <- df_week |> create_plot_df(play)

plot_df |>
  ungroup() |>
  #filter(frame_id >= 24) |>
  mutate(turn_angle = abs(turn_angle)) |>
  ggplot(
    aes(
      x_rel,
      y,
      #alpha = frame_id2,
      color = s_mph,
      group = nfl_id,
    ),
  ) +
  geom_point() +
  geom_text(
    aes(label = player_name),
    size = 2.4,
    color = 'black',
    data = \(x) x |> filter(frame_id2 == min(frame_id2))
  ) +
  geom_point(aes(ball_land_x_rel, ball_land_y), shape = 2, color = 'black')
```



```{r}
df |>
  inner_join(play) |>
  # filter(off_name == 'Trent Sherfield') |>
  select(
    off_name,
    frame_id2,
    vx,
    vy,
    def_vx,
    def_vy,
    turn_angle,
    def_turn_angle,
    angle_with_rec,
    diff_turn_angle
  ) |>
  mutate(
    delta = round(
      atan2(
        (turn_angle - def_turn_angle),
        turn_angle - def_turn_angle
      ),
      3
    )
  ) |>
  print(n = Inf) |>
  select(off_name, frame_id2, turn_angle, def_turn_angle, diff_turn_angle) |>
  #pivot_longer(cols = -c(frame_id2, off_name)) |>
  #mutate(value = value * 10) |>
  ggplot(aes(frame_id2)) +
  geom_line(aes(y=def_turn_angle), color='grey', linetype='dashed') +
  geom_line(aes(y = turn_angle), color='grey') +
  geom_line(aes(y=diff_turn_angle, color='diff_turn_angle'), show.legend = FALSE) +
  #geom_line(aes(color = name)) +
  facet_wrap(~off_name, ncol = 1)
```
